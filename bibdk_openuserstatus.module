<?php
module_load_include('inc', 'bibdk_openuserstatus', 'includes/bibdk_openuserstatus.form');
/**
 * Impelements user_profile_tabs (
 * @see ding_user.module)
 * */
function bibdk_openuserstatus_user_profile2_tabs() {
  global $user;
  $username = isset($user->mail) ? ' - ' . $user->mail : '';
  $ret = new stdClass();
  $ret->label = t('my_loanerstatus @username', array('@username' => $username), array('context' => 'bibdk_openuserstatus'));
  $ret->form = 'bibdk_openuserstatus_form';
  $ret->type = 'bibdk_openuserstatus';
  return $ret;
}

/**
 * Implement hook_ctools_plugin_api().
 */
function bibdk_openuserstatus_ctools_plugin_api($module, $api) {
  if ($module == 'page_manager' && $api == 'pages_default') {
    return array('version' => 1);
  }
}

/**
 * Implements hook_theme().
 * @return array
 */
function bibdk_openuserstatus_theme(){
  return array(
    'bibdk_openuserstatus' => array(
      'template' => 'theme/bibdk_openuserstatus',
    ),
  );
}

/**
 * get favourite libraries; get userstatus for each favourite
 * @return array; empty array if no favourites; else [agencyId => UserStatusResponse]
 */
function bibdk_openuserstatus_request() {
  $favourites = bibdk_openuserstatus_get_favourites();
  if (empty($favourites)) {
    return array();
  }
  $ret = array();
  foreach ($favourites as $favourite) {    
    $res = $favourite->getUserStatus();
    
    if ($res === FALSE) {
      continue;
    }
    
    if (isset($res['error'])) {      
      $ret[$favourite->getAgencyId()] = new UserStatusResponse(NULL,$res['error']);
    }
    else{
      $ret[$favourite->getAgencyId()] = new UserStatusResponse($res['response']);
    }
  }
  return $ret;
}

/** Implements hook_bibdk_reservation_complete
 *
 * unset $_SESSION variable for given library to
 * refresh orderlist
 *
 * @param mixed $pids; an array of order pid's
 * @param mixed $result; .. orderid of completed order
 */
function bibdk_openuserstatus_bibdk_reservation_complete($pids, $result) {
  // if an order has been completed BibdkReservationOrderObject is set
  // (@see bibdk_reservation.module::bibdk_reservation_new_order_object
  $library = BibdkReservationOrderObject::GetObject()->getBranchId();
  if (strpos($library, 'DK-') === 0) {
    // strip 'DK-' from librarynumber
    $library = substr($library, 3, strlen($library));
  }
  // @TODO should we just add an order to SESSION
  // instead of updating the whole thing ??
  // if we add an order from the data available, some elements will not be set
  // and a refresh button is probably needed
  if( isset($_SESSION['userStatus'][$library])){
    unset($_SESSION['userStatus'][$library]);
  }
}

function bibdk_openuserstatus_get_favourites() {
  static $ret;
  if (!isset($ret)) {
    if (!isset($_SESSION['bibdk_favourites'])) {
      _bibdk_favourite_set_agencies();
    }
    $favourites = isset($_SESSION['bibdk_favourites']) ? $_SESSION['bibdk_favourites'] : NULL;
    debug($favourites);
    foreach ($favourites as $favourite) {
      $ret[] = unserialize($favourite);
    }
  }
  return $ret;
}

/**
 * @param $agencyId
 * @return null|string
 */
function bibdk_openuserstatus_get_agencyname($agencyId) {
  $agency = new TingAgency($agencyId);
  return isset($agency->getBranch()->branchName) ? $agency->getBranch()->branchName : NULL;
}
